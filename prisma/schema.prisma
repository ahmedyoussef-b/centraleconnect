// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_REMOTE")
}

// --------------------------------------
// Nouveaux Enums
// --------------------------------------
enum MediaType {
  PHOTO
  VIDEO
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
}

// --------------------------------------
// Modèles de Base
// --------------------------------------

model User {
  id              String   @id @default(cuid())
  name            String?
  email           String   @unique
  role            String   @default("OPERATOR")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  createdEvidence VisualEvidence[]
  validatedTraining VisualTraining[]
}

model Equipment {
  externalId        String           @id @unique
  name              String
  description       String?
  parentId          String?
  type              String?
  subtype           String?
  systemCode        String?
  subSystem         String?
  location          String?
  manufacturer      String?
  serialNumber      String?
  documentRef       String?
  coordinates       Json?
  svgLayer          String?
  fireZone          String?
  linkedParameters  Json?
  status            String?          @default("UNKNOWN")
  version           Int              @default(1)
  isImmutable       Boolean          @default(false)
  approvedBy        String?
  approvedAt        DateTime?        @map("approved_at")
  commissioningDate DateTime?        @map("commissioning_date")
  checksum          String?          @unique
  nominalData       Json?
  
  parameters        Parameter[]
  alarms            Alarm[]
  logEntries        LogEntry[]
  
  // Relations inverses pour les nouvelles tables
  visualEvidence    VisualEvidence[]
  trainingData      VisualTraining[] @relation("TrainingEquipment")

  @@map("equipments")
}

model Parameter {
  id           Int      @id @default(autoincrement())
  equipmentId  String
  name         String
  unit         String?
  nominalValue Float?
  minSafe      Float?
  maxSafe      Float?
  alarmHigh    Float?
  alarmLow     Float?
  standardRef  String?
  equipment    Equipment @relation(fields: [equipmentId], references: [externalId], onDelete: Cascade)

  @@map("parameters")
}

model Alarm {
  code            String    @id @unique
  equipmentId     String    @map("equipment_id")
  severity        String
  description     String
  parameter       String?
  resetProcedure  String?   @map("reset_procedure")
  standardRef     String?   @map("standard_ref")
  equipment       Equipment @relation(fields: [equipmentId], references: [externalId], onDelete: Cascade)

  alarmEvents     AlarmEvent[]

  @@map("alarms")
}

model LogEntry {
  id          Int       @id @default(autoincrement())
  timestamp   DateTime
  type        String
  source      String
  message     String
  signature   String    @unique
  equipmentId String?
  equipment   Equipment? @relation(fields: [equipmentId], references: [externalId], onDelete: SetNull)

  // Relation optionnelle vers une preuve visuelle
  visualEvidenceId String?
  visualEvidence   VisualEvidence? @relation(fields: [visualEvidenceId], references: [id])

  @@map("log_entries")
}

model Procedure {
  id          String  @id
  name        String
  description String?
  version     String?
  steps       Json? // Stocke le JSON brut des étapes
  category    String?

  @@map("procedures")
}

// --------------------------------------
// Tables Spécifiques
// --------------------------------------

model SynopticItem {
  externalId    String    @id @unique
  name          String?
  type          String?
  parentId      String?
  groupPath     String?
  elementId     String?
  level         Int?
  approvedBy    String?
  approvalDate  String?

  @@map("synoptic_items")
}

model Annotation {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime
  text        String
  operator    String
  xPos        Float
  yPos        Float
  equipmentId String

  @@map("annotations")
}

model Document {
  id             Int       @id @default(autoincrement())
  imageData      String // Base64 ou URL
  ocrText        String?
  description    String?
  createdAt      DateTime  @default(now())
  perceptualHash String?
  equipmentId    String
  
  @@map("documents")
}


model AlarmEvent {
  id         Int      @id @default(autoincrement())
  timestamp  DateTime
  isActive   Boolean
  details    String?
  alarmCode  String
  alarm      Alarm    @relation(fields: [alarmCode], references: [code], onDelete: Cascade)

  @@map("alarm_events")
}

model ScadaData {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime
  value       Float
  equipmentId String
  
  @@map("scada_data")
}


// --------------------------------------
// Nouveaux Modèles
// --------------------------------------

model VisualEvidence {
  id             String   @id @default(cuid())
  
  // Média
  type           MediaType
  mimeType       String
  size           Int      // bytes
  width          Int?
  height         Int?
  duration       Int?     // secondes (vidéo)
  
  // Hashs
  sha256         String   @unique
  phash          String?  // Perceptual hash
  
  // Contexte
  equipmentId    String?
  equipment      Equipment? @relation(fields: [equipmentId], references: [externalId], onDelete: SetNull)
  procedureId    String?
  consignmentId  String?
  workOrderId    String?
  
  // Utilisateur
  createdById    String
  createdBy      User     @relation(fields: [createdById], references: [id])
  createdAt      DateTime @default(now())
  
  // Annotations
  annotations    Json[]   // Stockage flexible
  
  // Analyse IA
  analysis       Json?
  analysisVersion String?
  analysisAt     DateTime?
  
  // Traçabilité
  signature      String   // Chaîne confiance
  syncStatus     SyncStatus @default(PENDING)
  
  // Relation inverse
  logEntries     LogEntry[]
  trainingEntries VisualTraining[]

  @@index([equipmentId])
  @@index([phash])
  @@index([createdAt])
}

model VisualTraining {
  id             String   @id @default(cuid())
  
  // Donnée labellisée
  imageId        String
  image          VisualEvidence @relation(fields: [imageId], references: [id])
  
  // Labels humains
  equipmentId    String?
  equipment      Equipment? @relation("TrainingEquipment", fields: [equipmentId], references: [externalId])
  anomalyType    String?
  boundingBox    Json?    // [x,y,w,h]
  
  // Validation
  validatedById    String?
  validatedBy      User?     @relation(fields: [validatedById], references: [id])
  validatedAt    DateTime?
  
  createdAt      DateTime @default(now())
  
  @@unique([imageId, validatedById])
}
