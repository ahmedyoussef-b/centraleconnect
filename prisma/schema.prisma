generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Equipment {
  externalId        String        @id
  name              String
  description       String?
  parentId          String?
  parent            Equipment?    @relation("EquipmentHierarchy", fields: [parentId], references: [externalId], onDelete: NoAction, onUpdate: NoAction)
  children          Equipment[]   @relation("EquipmentHierarchy")
  type              String?
  subtype           String?
  systemCode        String?
  subSystem         String?
  location          String?
  manufacturer      String?
  serialNumber      String?
  tagNumber         String?       @unique
  documentRef       String?
  coordinates       String?
  svgLayer          String?
  fireZone          String?
  linkedParameters  String?
  status            String?
  version           Int           @default(1)
  isImmutable       Boolean       @default(false)
  approvedBy        String?
  approvedAt        DateTime?
  checksum          String?       @unique
  nominalData       String?
  parameters        Parameter[]
  alarms            Alarm[]
  logEntries        LogEntry[]
  documents         Document[]
  annotations       Annotation[]
  scadaData         ScadaData[]

  @@map("equipments")
}

model Parameter {
  id           Int      @id @default(autoincrement())
  equipmentId  String
  name         String
  unit         String?
  dataType     String   @default("TEXT")
  nominalValue Float?
  minSafe      Float?
  maxSafe      Float?
  warningHigh  Float?
  alarmHigh    Float?
  alarmLow     Float?
  standardRef  String?
  equipment    Equipment @relation(fields: [equipmentId], references: [externalId])

  @@unique([equipmentId, name])
  @@map("parameters")
}

model Alarm {
  code           String        @id
  equipmentId    String
  severity       AlarmSeverity
  description    String
  parameter      String?
  resetProcedure String?
  standardRef    String?
  equipment      Equipment     @relation(fields: [equipmentId], references: [externalId])
  events         AlarmEvent[]

  @@map("alarms")
}

model LogEntry {
  id          Int       @id @default(autoincrement())
  timestamp   DateTime
  type        LogType
  source      String
  message     String
  signature   String    @unique
  equipmentId String?
  equipment   Equipment? @relation(fields: [equipmentId], references: [externalId])

  @@map("log_entries")
}

model Annotation {
  id          Int      @id @default(autoincrement())
  equipmentId String
  text        String
  operator    String
  timestamp   DateTime
  xPos        Float
  yPos        Float
  equipment   Equipment @relation(fields: [equipmentId], references: [externalId])

  @@map("annotations")
}

model Document {
  id          Int      @id @default(autoincrement())
  equipmentId String
  imageData   String
  ocrText     String?
  description String?
  createdAt   DateTime
  equipment   Equipment @relation(fields: [equipmentId], references: [externalId])

  @@map("documents")
}

model Procedure {
  id          String @id
  name        String
  description String
  version     String
  steps       Json

  @@map("procedures")
}

model ScadaData {
  id          Int      @id @default(autoincrement())
  timestamp   DateTime
  equipmentId String
  value       Float
  equipment   Equipment @relation(fields: [equipmentId], references: [externalId])

  @@map("scada_data")
}

model AlarmEvent {
  id        Int      @id @default(autoincrement())
  alarmCode String
  timestamp DateTime @default(now())
  isActive  Boolean
  details   String?
  alarm     Alarm    @relation(fields: [alarmCode], references: [code])

  @@map("alarm_events")
}

model SynopticItem {
  externalId   String  @id
  name         String?
  type         String?
  parentId     String?
  groupPath    String?
  elementId    String?
  level        Int?
  approvedBy   String?
  approvalDate String?

  @@map("synoptic_items")
}

enum AlarmSeverity {
  INFO
  WARNING
  CRITICAL
  EMERGENCY
}

enum LogType {
  AUTO
  MANUAL
  DOCUMENT_ADDED
}
